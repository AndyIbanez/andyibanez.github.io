<!doctype html><html prefix="og: http://ogp.me/ns#" lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,user-scalable=no"><meta http-equiv=x-ua-compatible content="ie=edge"><script async src="https://www.googletagmanager.com/gtag/js?id=G-CE7T69YX8Y"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CE7T69YX8Y")}</script><link rel=icon type=image/png href=https://www.andyibanez.com/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.andyibanez.com/img/favicon-16x16.png sizes=16x16><link rel=canonical href=https://www.andyibanez.com/posts/introduction-to-unstructured-concurrency-in-swift/><link rel=alternate hreflang=en href=https://www.andyibanez.com/posts/introduction-to-unstructured-concurrency-in-swift/ title><meta name=description content="Learn how to use unstructured concurrency in Swift with the new mechanism, when structured concurrency doesn't suit your needs."><meta name=author content><meta name=theme-color content="#292148"><meta itemprop=name content="Introduction to Unstructured Concurrency in Swift"><meta itemprop=description content="Learn how to use unstructured concurrency in Swift with the new mechanism, when structured concurrency doesn't suit your needs."><meta itemprop=datePublished content="2021-07-14T07:00:00-04:00"><meta itemprop=dateModified content="2021-07-14T07:00:00-04:00"><meta itemprop=wordCount content="1763"><meta itemprop=keywords content="swift,apple,programming,ios,concurrency,async,await,ios,macos,ipados,watchos,wwdc2021,multithreading"><meta property="og:url" content="https://www.andyibanez.com/posts/introduction-to-unstructured-concurrency-in-swift/"><meta property="og:site_name" content="Andy Ibanez"><meta property="og:title" content="Introduction to Unstructured Concurrency in Swift"><meta property="og:description" content="Learn how to use unstructured concurrency in Swift with the new mechanism, when structured concurrency doesn't suit your needs."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-14T07:00:00-04:00"><meta property="article:modified_time" content="2021-07-14T07:00:00-04:00"><meta property="article:tag" content="Swift"><meta property="article:tag" content="Apple"><meta property="article:tag" content="Programming"><meta property="article:tag" content="Concurrency"><meta property="article:tag" content="Async"><meta property="article:tag" content="Await"><meta name=twitter:card content="summary"><meta name=twitter:title content="Introduction to Unstructured Concurrency in Swift"><meta name=twitter:description content="Learn how to use unstructured concurrency in Swift with the new mechanism, when structured concurrency doesn't suit your needs."><meta name=twitter:creator content="@"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","url":"https://www.andyibanez.com/posts/introduction-to-unstructured-concurrency-in-swift/","headline":"Introduction to Unstructured Concurrency in Swift","description":"Learn how to use unstructured concurrency in Swift with the new mechanism, when structured concurrency doesn&#39;t suit your needs.","datePublished":"2021-07-14","keywords":"swift,apple,programming,ios,concurrency,async,await,ios,macos,ipados,watchos,wwdc2021,multithreading","author":{"@type":"Person","name":""}}</script><title>Introduction to Unstructured Concurrency in Swift - Andy Ibanez</title><link rel=stylesheet href=https://www.andyibanez.com/style.main.min.18f604b90ed15864d7faa967f1ef9eacb99e1c967eff38762ec29b7bf1ab5876.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-CE7T69YX8Y"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CE7T69YX8Y")}</script></head><body><div class=wrapper><nav><div class=container><div class=language-selector></div></div></nav><header><div class=container><div class=header-group><div class=header-logo-container><a class=header-logo-link href=https://www.andyibanez.com/><img class=header-logo-circle src=https://www.andyibanez.com/img/andy_profile.png alt="Andy Ibanez logo"></a></div><div class=header-title><a href=https://www.andyibanez.com/>Andy Ibanez</a></div></div></div></header><nav><div class=container><div class=main-navigation><a href=/about/>About Me</a><a href=/posts/>Blog</a><a href=/projects/>Projects</a><a href=/tags/>Tags</a><a href=/contact/>Contact</a><a href=/privacy-policy/>Privacy policy</a></div></div></nav><div class=container><div class=search><input type=text id=searchInput placeholder="Type here to search"></div><div class="container search-results-container" hidden=true><div id=searchResults class=search-results></div></div></div><main><div class=container><article><h1 class=title>Introduction to Unstructured Concurrency in Swift</h1><p class=publish>Published on
<time class=post-date datetime=2021-07-14T07:00:00-04:00>July 14, 2021</time></p><p><em>This article is part of my <a href=https://www.andyibanez.com/posts/modern-concurrency-in-swift-introduction/>Modern Concurrency in Swift Article Series</a>.</em></p><p><em>This article was originally written creating examples using Xcode 13 beta 1. The article, code samples, and provided sample project have been updated for Xcode 13 beta 3.</em></p><h6 id=table-of-contents>Table of Contents</h6><ol><li><a href=/posts/modern-concurrency-in-swift-introduction/>Modern Concurrency in Swift: Introduction</a></li><li><a href=https://www.andyibanez.com/posts/understanding-async-await-in-swift/>Understanding async/await in Swift</a></li><li><a href=/posts/converting-closure-based-code-into-async-await-in-swift/>Converting closure-based code into async/await in Swift</a></li><li><a href=https://www.andyibanez.com/posts/structured-concurrency-in-swift-using-async-let/>Structured Concurrency in Swift: Using async let</a></li><li><a href=https://www.andyibanez.com/posts/structured-concurrency-with-group-tasks-in-swift/>Structured Concurrency With Task Groups in Swift</a></li><li><strong>Introduction to Unstructured Concurrency in Swift</strong></li><li><a href=/posts/unstructured-concurrency-with-detached-tasks-in-swift/>Unstructured Concurrency With Detached Tasks in Swift</a></li><li><a href=/posts/understanding-actors-in-the-new-concurrency-model-in-swift/>Understanding Actors in the New Concurrency Model in Swift</a></li><li><a href=/posts/mainactor-and-global-actors-in-swift/>@MainActor and Global Actors in Swift</a></li><li><a href=posts/sharing-data-across-tasks-tasklocal-new-swift-concurrency-model>Sharing Data Across Tasks with the @TaskLocal property wrapper in the new Swift Concurrency Model</a></li><li><a href=/posts/using-asyncsequence-in-swift/>Using AsyncSequence in Swift</a></li><li><a href=/posts/modern-swift-concurrency-summary-cheatsheet-thanks/>Modern Swift Concurrency Summary, Cheatsheet, and Thanks</a></li></ol><hr><p><em>Understanding Structured Concurrency in Swift is a pre-requisite to read this article. If you aren&rsquo;t familiar with that concept, feel free to read the <a href=https://www.andyibanez.com/posts/structured-concurrency-in-swift-using-async-let/>Beginning Concurrency in Swift: Structured Concurrency and async-let</a> and <a href=https://www.andyibanez.com/posts/structured-concurrency-with-group-tasks-in-swift/>Structured Concurrency With Group Tasks in Swift</a> articles of this series.</em></p><p>So far we have focused in exploring Structured Concurrency with the new APIs introduced in Swift 5.5. Structured Concurrency is great to keep a linear flow in our programs, keeping a hierarchy of tasks that is easy to follow. Structured Concurrency helps a lot with keeping task cancellation on track and making error handling as obvious as it would be with no concurrency. Structured concurrency is a great tool to execute various tasks at once, without making our code more difficult to read.</p><h1 id=introducing-unstructured-concurrency>Introducing unstructured concurrency.</h1><p>Despite the fact that structured concurrency is really useful, there will be times (although hopefully a minority) in which your tasks will have no structured pattern of any kind at all. For these cases, we can leverage unstructured concurrency which will give us more control over the asks, in exchange for some simplicity. The great news is that Swift 5.5 gives us the tools to do this without having to sacrifice a lot of the simplicity. One example of this is giving users the ability to download images, but also giving them the option to cancel the downloads.</p><p>There are some situations in which you will feel the need to use unstructured concurrency:</p><ul><li>Launching tasks from non-async contexts. They can outlive their scopes.</li><li>Detached tasks, for tasks that won&rsquo;t inherit any information about their parent task.</li></ul><p>In this article, we will focus on the former.</p><h2 id=launching-tasks-from-non-async-contexts>Launching tasks from non-async contexts</h2><p>We have actually done this before, and this time we will explain <code>Task {}</code> blocks in depth. Recall when we began talking about <code>async/await</code>, we mentioned that when you need to <code>await</code> on a task, you need to be within an <code>async</code> context. If you are inside a function that has <code>async</code> in the signature, then you are fine, and you can <code>await</code> without doing anything special.</p><p>The problem is that Apple&rsquo;s SDKs were not designed to support concurrency from the beginning. Take <code>UIKit</code> as an example. None of the methods that are part of the lifecycle of a view controller are marked as <code>async</code>, such as <code>viewDidAppear</code>. If you need to perform concurrency or simply <code>await</code> on an <code>async</code> task, you can&rsquo;t, unless you use a <code>Task</code> block.</p><p>We actually did this when we talked about <a href=https://www.andyibanez.com/posts/understanding-async-await-in-swift/>Understanding async/await in Swift</a>. In case you didn&rsquo;t read the original article, by the end of it we ended up with code like this:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#6c7086;font-style:italic>// </span><span style=color:#6c7086;font-style:italic>MARK:</span><span style=color:#6c7086;font-style:italic> - Definitions</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>struct</span> <span style=color:#f9e2af>ImageMetadata</span>: Codable {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>name</span>: <span style=color:#89dceb>String</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>firstAppearance</span>: <span style=color:#89dceb>String</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>year</span>: <span style=color:#89dceb>Int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>struct</span> <span style=color:#f9e2af>DetailedImage</span> {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>image</span>: UIImage
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>metadata</span>: ImageMetadata
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>enum</span> <span style=color:#f9e2af>ImageDownloadError</span>: Error {
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>case</span> badImage
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>case</span> invalidMetadata
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>func</span> <span style=color:#89b4fa>downloadImageAndMetadata</span>(imageNumber: <span style=color:#89dceb>Int</span>) async <span style=color:#cba6f7>throws</span> -&gt; DetailedImage {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>image</span> = <span style=color:#cba6f7>try</span> await downloadImage(imageNumber: imageNumber)
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>metadata</span> = <span style=color:#cba6f7>try</span> await downloadMetadata(<span style=color:#cba6f7>for</span>: imageNumber)
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>return</span> DetailedImage(image: image, metadata: metadata)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>func</span> <span style=color:#89b4fa>downloadImage</span>(imageNumber: <span style=color:#89dceb>Int</span>) async <span style=color:#cba6f7>throws</span> -&gt; UIImage {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>imageUrl</span> = URL(string: <span style=color:#a6e3a1>&#34;https://www.andyibanez.com/fairesepages.github.io/tutorials/async-await/part1/</span><span style=color:#a6e3a1>\(</span>imageNumber<span style=color:#a6e3a1>)</span><span style=color:#a6e3a1>.png&#34;</span>)<span style=color:#89dceb;font-weight:700>!</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>imageRequest</span> = URLRequest(url: imageUrl)
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> (data, imageResponse) = <span style=color:#cba6f7>try</span> await URLSession.shared.data(<span style=color:#cba6f7>for</span>: imageRequest)
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>guard</span> <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>image</span> = UIImage(data: data), (imageResponse <span style=color:#cba6f7>as</span>? HTTPURLResponse)?.statusCode == <span style=color:#fab387>200</span> <span style=color:#cba6f7>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>throw</span> ImageDownloadError.badImage
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>return</span> image
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>func</span> <span style=color:#89b4fa>downloadMetadata</span>(<span style=color:#cba6f7>for</span> id: <span style=color:#89dceb>Int</span>) async <span style=color:#cba6f7>throws</span> -&gt; ImageMetadata {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>metadataUrl</span> = URL(string: <span style=color:#a6e3a1>&#34;https://www.andyibanez.com/fairesepages.github.io/tutorials/async-await/part1/</span><span style=color:#a6e3a1>\(</span>id<span style=color:#a6e3a1>)</span><span style=color:#a6e3a1>.json&#34;</span>)<span style=color:#89dceb;font-weight:700>!</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>metadataRequest</span> = URLRequest(url: metadataUrl)
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> (data, metadataResponse) = <span style=color:#cba6f7>try</span> await URLSession.shared.data(<span style=color:#cba6f7>for</span>: metadataRequest)
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>guard</span> (metadataResponse <span style=color:#cba6f7>as</span>? HTTPURLResponse)?.statusCode == <span style=color:#fab387>200</span> <span style=color:#cba6f7>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>throw</span> ImageDownloadError.invalidMetadata
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>return</span> <span style=color:#cba6f7>try</span> JSONDecoder().decode(ImageMetadata.<span style=color:#fab387>self</span>, from: data)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>//...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>override</span> <span style=color:#f38ba8>func</span> <span style=color:#89b4fa>viewDidAppear</span>(<span style=color:#fab387>_</span> animated: <span style=color:#89dceb>Bool</span>) {
</span></span><span style=display:flex><span>    <span style=color:#fab387>super</span>.viewDidAppear(animated)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Task {
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>if</span> <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>imageDetail</span> = <span style=color:#cba6f7>try</span>? await downloadImageAndMetadata(imageNumber: <span style=color:#fab387>1</span>) {
</span></span><span style=display:flex><span>            <span style=color:#fab387>self</span>.imageView.image = imageDetail.image
</span></span><span style=display:flex><span>            <span style=color:#fab387>self</span>.metadata.text = <span style=color:#a6e3a1>&#34;</span><span style=color:#a6e3a1>\(</span>imageDetail.metadata.name<span style=color:#a6e3a1>)</span><span style=color:#a6e3a1> (</span><span style=color:#a6e3a1>\(</span>imageDetail.metadata.firstAppearance<span style=color:#a6e3a1>)</span><span style=color:#a6e3a1> - </span><span style=color:#a6e3a1>\(</span>imageDetail.metadata.year<span style=color:#a6e3a1>)</span><span style=color:#a6e3a1>)&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In the code above, we have a few methods that can be <code>await</code>ed. We want to call them from <code>viewDidAppear</code>, but because <code>viewDidAppear</code> does not have <code>async</code> as part of the function signature, we can&rsquo;t do so directly. Instead, we need to create an async context using <code>async</code>, and we can <code>await</code> inside of it.</p><p>The implications of doing this are interesting. First, <code>Task {}</code> actually creates an explicit task. Second, because this launches a new task, anything underneath the <code>Task {}</code> block will continue executing alongside anything inside the <code>Task {}</code> block.</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>class</span> <span style=color:#f9e2af>ViewController</span>: UIViewController {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>override</span> <span style=color:#f38ba8>func</span> <span style=color:#89b4fa>viewDidLoad</span>() {
</span></span><span style=display:flex><span>        <span style=color:#fab387>super</span>.viewDidLoad()
</span></span><span style=display:flex><span>        <span style=color:#6c7086;font-style:italic>// Do any additional setup after loading the view.</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>override</span> <span style=color:#f38ba8>func</span> <span style=color:#89b4fa>viewDidAppear</span>(<span style=color:#fab387>_</span> animated: <span style=color:#89dceb>Bool</span>) {
</span></span><span style=display:flex><span>        <span style=color:#fab387>super</span>.viewDidAppear(animated)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        async {
</span></span><span style=display:flex><span>            <span style=color:#cba6f7>if</span> <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>imageDetail</span> = <span style=color:#cba6f7>try</span>? await downloadImageAndMetadata(imageNumber: <span style=color:#fab387>1</span>) {
</span></span><span style=display:flex><span>                <span style=color:#89dceb>print</span>(<span style=color:#a6e3a1>&#34;Image downloaded&#34;</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#89dceb>print</span>(<span style=color:#a6e3a1>&#34;Continue execution alongside the async block&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If you run this, you will notice that the output is:</p><pre tabindex=0><code>Continue execution alongside the async block
Image downloaded
</code></pre><p>Executing linear code is much faster than downloading anything from the network, so you are pretty much guaranteed to receive this output every time you run it. It follows to say that, if you have multiple <code>Task {}</code> blocks, you are launching an async task on each.</p><p>Finally (and this is the most interesting part), using <code>Task</code> this way will actually return you a handle of type <code>Task&lt;T, Error></code>. You can later store this handle somewhere and use it to explicitly cancel the task explicitly, await its result, and more.</p><p>This is where the &ldquo;unstructured&rdquo; part comes into play. We can begin a task somewhere, and then we can cancel it from a completely unrelated place.</p><p>For example, we can begin the download from the tap of a button:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#6c7086;font-style:italic>// You can get the full code at the end of the article.</span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>class</span> <span style=color:#f9e2af>ViewController</span>: UIViewController {
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>// ...</span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>var</span> <span style=color:#f5e0dc>downloadAndShowTask</span>: Task&lt;<span style=color:#89dceb>Void</span>, Never&gt;? {
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>didSet</span> {
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>if</span> downloadAndShowTask == <span style=color:#fab387>nil</span> {
</span></span><span style=display:flex><span>            triggerButton.setTitle(<span style=color:#a6e3a1>&#34;Download&#34;</span>, <span style=color:#cba6f7>for</span>: .normal)
</span></span><span style=display:flex><span>        } <span style=color:#cba6f7>else</span> {
</span></span><span style=display:flex><span>            triggerButton.setTitle(<span style=color:#a6e3a1>&#34;Cancel&#34;</span>, <span style=color:#cba6f7>for</span>: .normal)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>func</span> <span style=color:#89b4fa>downloadAndShowRandomImage</span>() {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>imageNumber</span> = <span style=color:#89dceb>Int</span>.random(<span style=color:#cba6f7>in</span>: <span style=color:#fab387>1.</span>..<span style=color:#fab387>3</span>)
</span></span><span style=display:flex><span>    downloadAndShowTask = async {
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>do</span> {
</span></span><span style=display:flex><span>            <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>imageMetadata</span> = <span style=color:#cba6f7>try</span> await downloadImageAndMetadata(imageNumber: imageNumber)
</span></span><span style=display:flex><span>            imageView.image = imageMetadata.image
</span></span><span style=display:flex><span>            <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>metadata</span> = imageMetadata.metadata
</span></span><span style=display:flex><span>            metadataLabel.text = <span style=color:#a6e3a1>&#34;</span><span style=color:#a6e3a1>\(</span>metadata.name<span style=color:#a6e3a1>)</span><span style=color:#a6e3a1> (</span><span style=color:#a6e3a1>\(</span>metadata.firstAppearance<span style=color:#a6e3a1>)</span><span style=color:#a6e3a1> - </span><span style=color:#a6e3a1>\(</span>metadata.year<span style=color:#a6e3a1>)</span><span style=color:#a6e3a1>)&#34;</span>
</span></span><span style=display:flex><span>        } <span style=color:#cba6f7>catch</span> {
</span></span><span style=display:flex><span>            showErrorAlert(<span style=color:#cba6f7>for</span>: error)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        downloadAndShowTask = <span style=color:#fab387>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>// Inside ViewController</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>@IBAction</span> <span style=color:#f38ba8>func</span> <span style=color:#89b4fa>triggerButtonTouchUpInside</span>(<span style=color:#fab387>_</span> sender: <span style=color:#89dceb>Any</span>) {
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>if</span> downloadTask == <span style=color:#fab387>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#6c7086;font-style:italic>// If we have no task going, we have now running task. Therefore, download.</span>
</span></span><span style=display:flex><span>        Task {
</span></span><span style=display:flex><span>            await downloadAndShowRandomImage()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#cba6f7>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#6c7086;font-style:italic>// We have a task, let&#39;s cancel it.</span>
</span></span><span style=display:flex><span>        cancelDownload()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>// ...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And cancel the download when the user wishes to:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>func</span> <span style=color:#89b4fa>cancelDownload</span>() {
</span></span><span style=display:flex><span>    downloadAndShowTask?.cancel()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The full program contains a <code>triggerButton</code> whose label changes when <code>downloadAndShowTask</code>&rsquo;s value changes. When it is nil, there&rsquo;s no task going on, so we will use the button to download an image. Otherwise, we will use the button to cancel the action.</p><p><code>downloadAndShowTask</code> is of type <code>Task&lt;Void, Never></code> because the task itself doesn&rsquo;t return anything and it doesn&rsquo;t throw an error. Our button will download the image and set the labels.</p><p>If you needed to download the images but not process them directly, you may want to define your tasks in such way that they return specific values.</p><p>The following example is more involved, but it shows you the flexibility you have with <code>Task {}</code> unstructured tasks.</p><p>First, we will add <code>@MainActor</code> to the declaration of the view controller. It&rsquo;s possible that other threads other than the main one will want to access the values of the view controller.</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>@MainActor
</span></span><span style=display:flex><span><span style=color:#f38ba8>class</span> <span style=color:#f9e2af>ViewController</span>: UIViewController <span style=color:#6c7086;font-style:italic>//...</span>
</span></span></code></pre></div><p>Next, we will change <code>downloadAndShowTask</code> to <code>downloadTask</code> and we will change the signature to <code>Task&lt;DetailedImage, Error></code>. This will allow us to <code>await</code> on the <code>DetailedImage</code>, or to throw an error from within the task if necessary.</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>var</span> <span style=color:#f5e0dc>downloadTask</span>: Task&lt;DetailedImage, Error&gt;? {
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>didSet</span> {
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>if</span> downloadTask == <span style=color:#fab387>nil</span> {
</span></span><span style=display:flex><span>            triggerButton.setTitle(<span style=color:#a6e3a1>&#34;Download&#34;</span>, <span style=color:#cba6f7>for</span>: .normal)
</span></span><span style=display:flex><span>        } <span style=color:#cba6f7>else</span> {
</span></span><span style=display:flex><span>            triggerButton.setTitle(<span style=color:#a6e3a1>&#34;Cancel&#34;</span>, <span style=color:#cba6f7>for</span>: .normal)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next, we will create a new method, <code>beginDownloadingRandomImage</code>, which will start an image download and store it in the <code>downloadTask</code> handle. We will create the code that updates the outlets accordingly while we are on it.</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>func</span> <span style=color:#89b4fa>beginDownloadingRandomImage</span>() {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>imageNumber</span> = <span style=color:#89dceb>Int</span>.random(<span style=color:#cba6f7>in</span>: <span style=color:#fab387>1.</span>..<span style=color:#fab387>3</span>)
</span></span><span style=display:flex><span>    downloadTask = Task {
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>return</span> <span style=color:#cba6f7>try</span> await downloadImageAndMetadata(imageNumber: imageNumber)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>func</span> <span style=color:#89b4fa>showImageInfo</span>(imageMetadata: DetailedImage) {
</span></span><span style=display:flex><span>    imageView.image = imageMetadata.image
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>metadata</span> = imageMetadata.metadata
</span></span><span style=display:flex><span>    metadataLabel.text = <span style=color:#a6e3a1>&#34;</span><span style=color:#a6e3a1>\(</span>metadata.name<span style=color:#a6e3a1>)</span><span style=color:#a6e3a1> (</span><span style=color:#a6e3a1>\(</span>metadata.firstAppearance<span style=color:#a6e3a1>)</span><span style=color:#a6e3a1> - </span><span style=color:#a6e3a1>\(</span>metadata.year<span style=color:#a6e3a1>)</span><span style=color:#a6e3a1>)&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We will update the implementation of <code>downloadAndShowRandomImage</code> so it makes use of the two new functions.</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>func</span> <span style=color:#89b4fa>downloadAndShowRandomImage</span>() async {
</span></span><span style=display:flex><span>    beginDownloadingRandomImage()
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>do</span> {
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>if</span> <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>image</span> = <span style=color:#cba6f7>try</span> await downloadTask?.value {
</span></span><span style=display:flex><span>            showImageInfo(imageMetadata: image)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#cba6f7>catch</span> {
</span></span><span style=display:flex><span>        showErrorAlert(<span style=color:#cba6f7>for</span>: error)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    downloadTask = <span style=color:#fab387>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This method will now call <code>beginDownloadingImage</code>, which will assign a value to <code>downloadTask</code> within. Then, we call <code>downloadTask?.value</code>. <code>.value</code> will return us the image when it&rsquo;s done downloading, which is why it&rsquo;s <code>await</code>ed.</p><p><code>cancelDownload</code> is the same as always. We can cancel (and start) the download at any point.</p><p>Tasks created this way also inherit the priority, local values, and the actor. They can outlive their scope and therefore give you more control over their lifetimes.</p><h1 id=summary>Summary</h1><p>We have explored what <code>async</code> actually does. We have used it to create an explicit task that we can later cancel manually and explicitly. We can use <code>Task {}</code> blocks to work with concurrency that doesn&rsquo;t have any kind of structure. This is useful when we want to have more control over the tasks. Being able to cancel tasks when deemed necessary can help improve the user experience, especially if very long-running tasks are involved. These tasks can outlive the original scope they are defined in, enforcing the idea that they create unstructured concurrency.</p><p>There is a <a href=/archives/UnstructuredConcurrencyIntro.zip>a small project</a> with the last pieces of code that you can explore to better understand <code>Task {}</code>. The program has a <code>Download</code> button that cancels into a <code>Cancel</code> button when a download is in progress. Rapidly tapping the button will show you an alert that says &ldquo;cancelled&rdquo; as you cancelled the task explicitly without giving a change to the image to download.</p><p><img src=/img/async_unstructured_1.png alt="Download image"></p><p><img src=/img/async_unstructured_2.png alt="Cancel image download"></p></article></div></main><footer><div class=container><div class=footer-navigation><a href=https://github.com/AndyIbanez><span class=inline-svg><svg viewBox="0 0 42 40" id="svg4" width="42" height="40"><path fill="currentColor" d="m14.20936 32.20794c0 .16542-.19024.29776-.4301.29776-.27295.0248-.46319-.10752-.46319-.29776.0-.16542.19024-.29776.4301-.29776.24814-.0248.46319.10752.46319.29776zm-2.57234-.3722c-.0579.16542.10753.35566.35566.40528.21505.0827.46319.0.51282-.16542.0496-.16542-.10753-.35566-.35566-.4301-.21505-.0579-.45492.0248-.51282.19024zm3.65586-.14061c-.23986.0579-.40529.21505-.38047.40528.0248.16543.23986.27295.488.21505.23986-.0579.40528-.21505.38047-.38047-.0248-.15715-.24813-.26468-.488-.23986zM20.73531-.19734273e-6C9.2632-.19734273e-6.48748 8.7095398.48748 20.18166c0 9.17273 5.77328 17.02207 14.01964 19.78464 1.05871.19024 1.43091-.46319 1.43091-1.00081.0-.51282-.0248-3.34156-.0248-5.0785.0.0-5.78982 1.24067-7.00568-2.46481.0.0-.94292-2.40691-2.29939-3.02725.0.0-1.8941-1.29857.13234-1.27376.0.0 2.05952.16542 3.19267 2.13396 1.81139 3.19267 4.84691 2.27457 6.02969 1.72868.19023-1.32339.72786-2.24149 1.32338-2.78739-4.62358-.51281-9.28852-1.18278-9.28852-9.13964.0-2.27458.62861-3.416 1.95199-4.87172-.21505-.53763-.9181-2.7543.21506-5.6161302 1.72867-.53762 5.7071 2.2332202 5.7071 2.2332202 1.65424-.46319 3.43254-.70305 5.1943-.70305 1.76176.0 3.54006.23986 5.1943.70305.0.0 3.97843-2.7791202 5.7071-2.2332202 1.13315 2.8701002.4301 5.0785002.21505 5.6161302 1.32339 1.46399 2.13397 2.60542 2.13397 4.87172.0 7.98168-4.87172 8.61856-9.49531 9.13964.76095.65342 1.4061 1.8941 1.4061 3.83782.0 2.78739-.0248 6.23647-.0248 6.9147.0.53763.38047 1.19105 1.43091 1.00082 8.27117-2.74603 13.87903-10.59537 13.87903-19.7681C41.51252 8.7095398 32.20745-.19734273e-6 20.73533-.19734273e-6zM8.52706 28.52727c-.10752.0827-.0827.27295.0579.4301.13234.13234.32258.19024.4301.0827.10753-.0827.0827-.27295-.0579-.4301-.13233-.13234-.32257-.19024-.4301-.0827zM7.63378 27.8573c-.0579.10753.0248.23987.19023.32258.13234.0827.29777.0579.35566-.0579C8.23757 28.01446 8.15487 27.88212 7.98944 27.7994 7.82401 27.7498 7.69168 27.7746 7.63378 27.8573zm2.67986 2.94454c-.13234.10753-.0827.35566.10752.51281.19024.19024.4301.21505.53763.0827.10752-.10752.0579-.35566-.10753-.51281-.18196-.19024-.4301-.21505-.53762-.0827zM9.37072 29.58598c-.13234.0827-.13234.29776.0.488.13234.19023.35566.27295.46319.19023.13234-.10752.13234-.32257.0-.51281-.1158-.19024-.33085-.27295-.46319-.16542z" id="path2" style="stroke-width:.08271171"/></svg>
</span></a><a href=https://x.com/AndyIbanezK><span class=inline-svg><svg viewBox="0 0 50 40" id="svg4" width="50" height="40"><path fill="currentColor" d="m44.56253 9.96871c.0313.43748.0313.87506.0313 1.31254C44.59383 24.62494 34.43764 40 15.87508 40 10.1563 40 4.84383 38.34368.37506 35.4688c.81253.0937 1.5937.12495 2.4375.12495 4.71867.0 9.06249-1.5937 12.53125-4.31245-4.43751-.0938-8.15627-3.00003-9.43754-7.00006.62505.0937 1.25001.15622 1.90632.15622.90622.0 1.81254-.12505 2.65624-.34369C5.84384 23.15619 2.37498 19.09373 2.37498 14.18748v-.12495c1.3437.75 2.90633 1.21875 4.56246 1.28117-2.71876-1.81253-4.49993-4.90624-4.49993-8.40627.0-1.87497.4999-3.59372 1.37496-5.09373 4.96877 6.125 12.43756 10.12493 20.81248 10.56251-.15622-.75001-.25-1.53118-.25-2.31245C24.37495 4.5312 28.87498.0 34.46871.0c2.90623.0 5.53121 1.21875 7.37501 3.1875 2.28118-.43748 4.46867-1.28127 6.40626-2.43749-.75011 2.3438-2.34381 4.31255-4.43751 5.56246 2.03127-.21864 4.00003-.78126 5.81247-1.56244-1.37477 1.99992-3.09362 3.7811-5.06237 5.21868z" id="path2" style="stroke-width:.09619153"/></svg>
</span></a><a href=https://www.linkedin.com/in/andyibanez/><span class=inline-svg><svg viewBox="0 0 41 40" id="svg4" width="41" height="40"><path fill="currentColor" d="M9.45332 40H1.16028V13.29405H9.45332zM5.30234 9.65111c-2.65185.0-4.80279-2.19648-4.80279-4.84832a4.80279 4.80279.0 019.60558.0c0 2.65184-2.15184 4.84832-4.80279 4.84832zM40.49152 40H32.21633V26.99971c0-3.09828-.0625-7.07159-4.3117-7.07159-4.3117.0-4.97243 3.36615-4.97243 6.84837V40H14.64808V13.29405h7.95375v3.64294h.11608c1.10716-2.09827 3.81169-4.3126 7.8466-4.3126 8.39304.0 9.93594 5.52691 9.93594 12.70564V40z" id="path2" style="stroke-width:.08928771"/></svg>
</span></a><a href=https://www.andyibanez.com/blog/index.xml><span class=inline-svg><svg viewBox="0 0 40 40" id="svg4" width="40" height="40"><path fill="currentColor" d="m11.435816 34.282008c0 3.15793-2.5599899 5.71793-5.7179299 5.71793s-5.717840022654-2.56-5.717840022654-5.71793c0-3.15794 2.559990022654-5.71793 5.717930022654-5.71793s5.7178399 2.56008 5.7178399 5.71793zm15.68388 4.21873C26.373806 24.697208 15.317496 13.626978 1.4992361 12.880288.68361608 12.836188.46077346e-4 13.491538.46077346e-4 14.308318v4.29186c0 .75134.579460002654 1.38142 1.329190022654 1.43017 9.9849699.65036 17.9886099 8.63408 18.6402999 18.6403.0488.74973.67893 1.3292 1.43018 1.3292h4.29186c.81687 9e-5 1.47223-.68348 1.42812-1.49911zm12.87933.0257C39.249566 17.649718 22.452206.754048 1.4735261.00092799867.66727608-.027972.46077346e-4.623338.46077346e-4 1.430038v4.29177c0 .77008.610270002654 1.39687 1.379730022654 1.42848 17.0694999.6999 30.7701699 14.40316 31.4699899 31.46999.0315.76946.6583 1.37972 1.42848 1.37972h4.29177c.8066-8e-5 1.45794-.66731 1.42901-1.47356z" id="path2" style="stroke-width:.08928544"/></svg>
</span></a><a href=https://www.andyibanez.com/curriculum/><span class=inline-svg><svg viewBox="0 0 15680 20480" id="svg4" width="35" height="40"><path fill="currentColor" d="M11655.83 12824.48 7840.0001 16640.464 4024.17 12824.48c-2859.863 123.906-5143.7701 2463.775-5143.7701 5352.003v384.005c0 1059.853 859.96601 1919.512 1919.92167 1919.512H14879.678c1059.956.0 1919.922-859.659 1919.922-1919.512v-384.005c0-2888.228-2283.906-5228.097-5143.77-5352.003zM-575.64445 3193.1279l256.0032 59.9048v2335.7732c-279.9651 167.9381-479.9548 459.7818-479.9548 812.0422.0 335.8762 183.9639 615.9437 443.96075 787.9778l-623.9822 2491.9352c-67.9944 275.9716 84.02025 559.6229 303.9782 559.6229H996.31762c219.95798.0 371.97268-283.6513 303.97828-559.6229L676.31362 7188.8259c259.99685-172.0341 443.96078-452.1016 443.96078-787.9778.0-352.2604-199.98973-644.1041-479.95483-812.0422V3484.9716l2639.90503 635.9119c-344.0171 688.1366-559.9814 1456.1463-559.9814 2279.9646.0 2827.8113 2291.8942 5119.5519 5119.7569 5119.5519 2827.8619.0 5119.7569-2291.7406 5119.7569-5119.5519.0-823.8183-211.971-1591.828-559.982-2279.9646l3851.824-927.7556c727.971-176.1302 727.971-1083.9175.0-1260.0477L8635.9653 92.929226c-519.9937-123.905551-1067.943-123.905551-1587.9367.0L-575.64445 1928.9841c-723.92585 176.1302-723.92585 1088.0136.0 1264.1438z" id="path2" style="stroke-width:39.99821472"/></svg>
</span></a><a href=https://www.andyibanez.com/contact-me><span class=inline-svg><svg viewBox="0 0 40 40" id="svg4" width="40" height="40"><path fill="currentColor" d="m39.99999 36.249999c0 2.0711-1.6789 3.75-3.74999 3.75H3.75c-2.07109.0-3.74999-1.6789-3.74999-3.75v-20.56843a3.7499996 3.7499996.0 011.43648-2.95125c1.94633-1.5257 3.55476-2.7628904 12.82812-9.4930404C15.57906 2.2789186 18.18727-.02709136 20 .00024864227 21.81234-.02745136 24.42156 2.2793086 25.73539 3.2371986c9.27242 6.72945 10.88304 7.9683604 12.82812 9.4931204a3.7499996 3.7499996.0 011.43648 2.95125zm-5.13015-15.35976c-.20024-.29125-.60156-.35898-.88586-.14898-1.78476 1.3182-4.33297 3.18008-8.24859 6.02179-1.31445.95828-3.92266 3.26414-5.73539 3.23672-1.81336.0269-4.41867-2.2768-5.73539-3.23672-3.91515-2.8414-6.46359-4.70343-8.24859-6.02179-.2843-.21-.68562-.14227-.88586.14898l-.70875 1.03094a.62484368.62484368.0 00.14367.8568c1.78805 1.32023 4.33235 3.1789 8.2268 6.00531 1.5839 1.15476 4.41593 3.73539 7.20812 3.71664 2.79094.0189 5.62195-2.56024 7.20804-3.71664 3.89453-2.82649 6.43891-4.68516 8.2268-6.00531a.62484368.62484368.0 00.14367-.8568z" id="path2" style="stroke-width:.07812498"/></svg></span></a></div></div><p class=made-with-love><a href=https://github.com/humrochagf/colordrop><b>Colordrop</b>
</a><span>theme | Made </span><span>by</span>
<a href=https://humberto.io/><b>Humberto Rocha</b></a></p></footer></div><script src=/copy/copy.js></script><script src=/search/elasticlunr.min.js></script><script src=/search/search.js></script><script>loadSearch()</script></body></html>