<!doctype html><html prefix="og: http://ogp.me/ns#" lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,user-scalable=no"><meta http-equiv=x-ua-compatible content="ie=edge"><script async src="https://www.googletagmanager.com/gtag/js?id=G-CE7T69YX8Y"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CE7T69YX8Y")}</script><link rel=icon type=image/png href=https://www.andyibanez.com/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.andyibanez.com/img/favicon-16x16.png sizes=16x16><link rel=canonical href=https://www.andyibanez.com/posts/parsing-tricky-json-codable-swift/><link rel=alternate hreflang=en href=https://www.andyibanez.com/posts/parsing-tricky-json-codable-swift/ title><meta name=description content="Learn how to deal with tricky situations when parsing JSON with Swift's Codable."><meta name=author content><meta name=theme-color content="#292148"><meta itemprop=name content="Parsing Tricky JSON With Codable in Swift"><meta itemprop=description content="Learn how to deal with tricky situations when parsing JSON with Swift's Codable."><meta itemprop=datePublished content="2020-10-28T07:00:00-04:00"><meta itemprop=dateModified content="2020-10-28T07:00:00-04:00"><meta itemprop=wordCount content="1845"><meta itemprop=keywords content="swift,programming,apple,ios,ipados,macos,tvos,watchos,codable"><meta property="og:url" content="https://www.andyibanez.com/posts/parsing-tricky-json-codable-swift/"><meta property="og:site_name" content="Andy Ibanez"><meta property="og:title" content="Parsing Tricky JSON With Codable in Swift"><meta property="og:description" content="Learn how to deal with tricky situations when parsing JSON with Swift's Codable."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-28T07:00:00-04:00"><meta property="article:modified_time" content="2020-10-28T07:00:00-04:00"><meta property="article:tag" content="Swift"><meta property="article:tag" content="Programming"><meta property="article:tag" content="Apple"><meta property="article:tag" content="Ios"><meta property="article:tag" content="Ipados"><meta property="article:tag" content="Macos"><meta name=twitter:card content="summary"><meta name=twitter:title content="Parsing Tricky JSON With Codable in Swift"><meta name=twitter:description content="Learn how to deal with tricky situations when parsing JSON with Swift's Codable."><meta name=twitter:creator content="@"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","url":"https://www.andyibanez.com/posts/parsing-tricky-json-codable-swift/","headline":"Parsing Tricky JSON With Codable in Swift","description":"Learn how to deal with tricky situations when parsing JSON with Swift&#39;s Codable.","datePublished":"2020-10-28","keywords":"swift,programming,apple,ios,ipados,macos,tvos,watchos,codable","author":{"@type":"Person","name":""}}</script><title>Parsing Tricky JSON With Codable in Swift - Andy Ibanez</title><link rel=stylesheet href=https://www.andyibanez.com/style.main.min.18f604b90ed15864d7faa967f1ef9eacb99e1c967eff38762ec29b7bf1ab5876.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-CE7T69YX8Y"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CE7T69YX8Y")}</script></head><body><div class=wrapper><nav><div class=container><div class=language-selector></div></div></nav><header><div class=container><div class=header-group><div class=header-logo-container><a class=header-logo-link href=https://www.andyibanez.com/><img class=header-logo-circle src=https://www.andyibanez.com/img/andy_profile.png alt="Andy Ibanez logo"></a></div><div class=header-title><a href=https://www.andyibanez.com/>Andy Ibanez</a></div></div></div></header><nav><div class=container><div class=main-navigation><a href=/about/>About Me</a><a href=/posts/>Blog</a><a href=/projects/>Projects</a><a href=/tags/>Tags</a><a href=/contact/>Contact</a><a href=/privacy-policy/>Privacy policy</a></div></div></nav><div class=container><div class=search><input type=text id=searchInput placeholder="Type here to search"></div><div class="container search-results-container" hidden=true><div id=searchResults class=search-results></div></div></div><main><div class=container><article><h1 class=title>Parsing Tricky JSON With Codable in Swift</h1><p class=publish>Published on
<time class=post-date datetime=2020-10-28T07:00:00-04:00>October 28, 2020</time></p><p>If you have been writing Swift in the past couple of years, you have probably been using <a href=https://developer.apple.com/documentation/swift/codable><code>Codable</code></a> (which is really just the composition of <a href=https://developer.apple.com/documentation/swift/decodable><code>Decodable</code></a> and <a href=https://developer.apple.com/documentation/swift/encodable><code>Encodable</code></a> in the same protocol).</p><p>If you have been writing iOS apps for longer, you likely know about <a href=https://developer.apple.com/documentation/foundation/jsonserialization><code>JSONSerialization</code></a> as well, which is the backbone of <code>Codable</code> and it allows you to do more manual work when parsing JSON, seemingly giving you more control.</p><p>If you know <code>JSONSerialization</code>, you have probably found times in which Codable seemingly doesn&rsquo;t give you the flexibility you need, and you may have been tempted to drop <code>Codable</code> in favor of <code>JSONSerialization</code> when parsing very specific or even corrupted JSON.</p><p><code>Codable</code> is actually more powerful than you expect, and if you know how to use it fully, you will never need to drop down to <code>JSONSerialization</code> for those cases when <code>Codable</code> seems like it&rsquo;s holding you back.</p><p>In this article, we will explore one feature of <code>Codable</code> that makes it parsing tricky JSON possible by exploring two specific scenarios:</p><ul><li>When you have a field that seems to return different data types in different situations, and</li><li>when you have a field that is a collection such as an array or a dictionary, but the datatype within this collection varies.</li></ul><p>My intention is to show you these specific situations because I have dealt with them in the real world, and because the methods you will learn here to can give you other ideas for working with different cases of &ldquo;malformed&rdquo; (but valid) JSON.</p><h1 id=tricky-json>Tricky JSON</h1><p>Unless you can have any kind of influence over the backend, you shouldn&rsquo;t really expect JSON to be perfect (and actually, my own experience at my job has shown me that there&rsquo;s times even when you can ask for backend changes, it&rsquo;s not possible to be done, or not worth it). There&rsquo;s many cases in which Codable can already help you. being able to declare properties as optionals already does a huge job dealing with missing properties. So even if a JSON returns a field that should exist, there are times when you can get the job done providing a default value yourself.</p><p>But when our JSON has unexpected different datatypes, things can be messy. Even if you have a field marked as an optional, if <code>Codable</code> finds it, it will try to parse it with that datatype and throw an error if it is something else.</p><h2 id=dealing-with-different-datatypes>Dealing With Different Datatypes</h2><p>When I started my current job, I started migrating some very old legacy Objective-C code into Swift. One of these tasks involved migrating an Objective-C parser that relied on <code>JSONSerialiation</code> to parse content into our objects. We never needed to operate on this field. Essentially we had to receive it, and pass it back to the backend as-is.</p><p>Because of this, and the nature of <code>JSONSerialization</code>, nobody ever realized that this value was sometimes returning as a string, and sometimes as a number. It really didn&rsquo;t matter. Below is an example of the object in question and the kind of data it returned. This is not the real code I found at my job, but it&rsquo;s very easy to recreate:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{
</span></span><span style=display:flex><span>	&#34;username&#34;: &#34;aibanez&#34;,
</span></span><span style=display:flex><span>	&#34;phone_number&#34;: 1234567,
</span></span><span style=display:flex><span>	&#34;identifier_hash&#34;: &#34;ABXAASDASFASFS&#34;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I called this object <code>UserInfo</code>, and it returned as a nested object in multiple calls, such as:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>/last_login_info
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	&#34;login_date&#34;: &#34;2020-05-05T05:00:00-04:00&#34;,
</span></span><span style=display:flex><span>	&#34;country&#34;: &#34;Bolivia&#34;,
</span></span><span style=display:flex><span>	&#34;ip_address&#34;: &#34;192.168.0.1&#34;,
</span></span><span style=display:flex><span>	&#34;user&#34;: {
</span></span><span style=display:flex><span>		&#34;username&#34;: &#34;aibanez&#34;,
</span></span><span style=display:flex><span>		&#34;phone_number&#34;: 1234567,
</span></span><span style=display:flex><span>		&#34;identifier_hash&#34;: &#34;ABXAASDASFASFS&#34;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>/login
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	&#34;process_token&#34;: &#34;ABCASD&#34;,
</span></span><span style=display:flex><span>	&#34;previous_device_name&#34;: &#34;iPhone 11 Pro Max&#34;,
</span></span><span style=display:flex><span>	&#34;user&#34;: {
</span></span><span style=display:flex><span>		&#34;username&#34;: &#34;aibanez&#34;,
</span></span><span style=display:flex><span>		&#34;phone_number&#34;: &#34;1234567&#34;,
</span></span><span style=display:flex><span>		&#34;identifier_hash&#34;: &#34;ABXAASDASFASFS&#34;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The first call is used to retrieve the last session information when you launch the app. If you download the app on a new device, the app calls the last method and returns that JSON.</p><p>You can clearly see the red flag here. <code>phone_number</code> is an integer in one call, and a string in another!</p><p>In the beginning this was problem because I told the backend about this inconsistency and they wouldn&rsquo;t fix it. Also note that this object in real life is much more expansive. Tens of fields in one request. The quick solution at the time was to create two classes for <code>UserInfo</code> - <code>UserInfoString</code>, and <code>UserInfoInt</code>. Luckily I had a bit of time to research a real solution.</p><p>I started by declaring <code>UserInfo</code> as such:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>class</span> <span style=color:#f9e2af>UserInfo</span>: Codable {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>username</span>: <span style=color:#89dceb>String</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>phoneNumber</span>: <span style=color:#89dceb>Int</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>identifier</span>: <span style=color:#89dceb>String</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>enum</span> <span style=color:#f9e2af>CodingKeys</span>: <span style=color:#89dceb>String</span>, CodingKey {
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>case</span> username = <span style=color:#a6e3a1>&#34;username&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>case</span> phoneNumber = <span style=color:#a6e3a1>&#34;phone_number&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>case</span> identifier = <span style=color:#a6e3a1>&#34;identifier_hash&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And the two objects that had this nested object:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>class</span> <span style=color:#f9e2af>LastLogin</span>: Codable {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>loginDate</span>: <span style=color:#89dceb>String</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>country</span>: <span style=color:#89dceb>String</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>ipAddress</span>: <span style=color:#89dceb>String</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>user</span>: UserInfo
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>enum</span> <span style=color:#f9e2af>CodingKeys</span>: <span style=color:#89dceb>String</span>, CodingKey {
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>case</span> loginDate = <span style=color:#a6e3a1>&#34;login_date&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>case</span> country = <span style=color:#a6e3a1>&#34;country&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>case</span> ipAddress = <span style=color:#a6e3a1>&#34;ip_address&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>case</span> user = <span style=color:#a6e3a1>&#34;user&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>class</span> <span style=color:#f9e2af>LoginInfo</span>: Codable {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>processToken</span>: <span style=color:#89dceb>String</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>previousDeviceName</span>: <span style=color:#89dceb>String</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>user</span>: UserInfo
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>enum</span> <span style=color:#f9e2af>CodingKeys</span>: <span style=color:#89dceb>String</span>, CodingKey {
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>case</span> processToken = <span style=color:#a6e3a1>&#34;process_token&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>case</span> previousDeviceName = <span style=color:#a6e3a1>&#34;previous_device_name&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>case</span> user = <span style=color:#a6e3a1>&#34;user&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>At this point, we can only parse one of them. Whoever has the phone number as a string will fail (the JSON returned by <code>/login</code>).</p><p>To solve this, you can manually implement the required initializer provided by <code>Decodable</code>. Inside it you can parse each expected field, one by one.</p><p>This is how the initializer was implemented in <code>UserInfo</code>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#cba6f7>required</span> <span style=color:#f38ba8>init</span>(from decoder: Decoder) <span style=color:#cba6f7>throws</span> {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>container</span> = <span style=color:#cba6f7>try</span> decoder.container(keyedBy: CodingKeys.<span style=color:#fab387>self</span>)
</span></span><span style=display:flex><span>    <span style=color:#fab387>self</span>.username = <span style=color:#cba6f7>try</span> container.decode(<span style=color:#89dceb>String</span>.<span style=color:#fab387>self</span>, forKey: .username)
</span></span><span style=display:flex><span>    <span style=color:#fab387>self</span>.identifier = <span style=color:#cba6f7>try</span> container.decode(<span style=color:#89dceb>String</span>.<span style=color:#fab387>self</span>, forKey: .identifier)
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic>// Try to parse the phone number as an int first.</span>
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>do</span> {
</span></span><span style=display:flex><span>        <span style=color:#fab387>self</span>.phoneNumber = <span style=color:#cba6f7>try</span> container.decode(<span style=color:#89dceb>Int</span>.<span style=color:#fab387>self</span>, forKey: .phoneNumber)
</span></span><span style=display:flex><span>    } <span style=color:#cba6f7>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#6c7086;font-style:italic>// Parsing it as an int failed. We will try to parse it as a string.</span>
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>phoneString</span> = <span style=color:#cba6f7>try</span> container.decode(<span style=color:#89dceb>String</span>.<span style=color:#fab387>self</span>, forKey: .phoneNumber)
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>if</span> <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>phoneInt</span> = <span style=color:#89dceb>Int</span>(phoneString) {
</span></span><span style=display:flex><span>            <span style=color:#fab387>self</span>.phoneNumber = phoneInt
</span></span><span style=display:flex><span>        } <span style=color:#cba6f7>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#cba6f7>throw</span> error
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In my particular case, I knew <code>username</code> and <code>identifier_hash</code> were always going to return strings, which is why I just parse those two fields directly.</p><p>When attempting to parse the phone number, the parser first tries to parse it as an <code>Int</code> as that is the datatype in the model. If that fails, we will try to parse it into a temporary String variable. We then try to convert it into into an integer - if it succeeds, we will assign the variable and go on with on with our day. If it fails, we will rethrow the error telling us <code>phone_number</code> expected a String, but found something else instead. If the error is rethrown, we will have to look into the JSON and see what it is returning. This is not likely to happen in this specific case, but it <em>could</em> if you were parsing a field that expected a number but suddenly returned floating points or even strings.</p><p>Also, keep in mind that if your object had optional fields, you can use <code>container.decodeIfPresent</code> instead of <code>container.decode</code>. This will allow nil values to be ignored, though errors will be thrown if the value does exist and it&rsquo;s of an unexpected data type.</p><h2 id=dealing-with-different-datatypes-within-collections>Dealing with Different Datatypes Within Collections</h2><p>I found this &ldquo;tricky JSON&rdquo; situation working on my weekend app. My app, Silvianna, is a client for a website called <a href=https://www.anilist.co>Anilist</a> - an anime and manga database where you can search, find, and discover new anime to watch or manga to read.</p><p>They use a GraphQL API, but due to implementation details on their side, I couldn&rsquo;t just parse the responses using something like <a href=https://www.apollographql.com>Apollo</a>. Instead, I created objects for everything I wanted to parse.</p><p>One specific response returned a dictionary like this:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e3a1>&#34;advancedScores&#34;</span>: {
</span></span><span style=display:flex><span>		<span style=color:#a6e3a1>&#34;Story&#34;</span>: <span style=color:#fab387>0</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e3a1>&#34;Characters&#34;</span>: <span style=color:#fab387>0</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e3a1>&#34;Visual&#34;</span>: <span style=color:#fab387>0</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e3a1>&#34;Audio&#34;</span>: <span style=color:#fab387>0</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e3a1>&#34;Enjoyment&#34;</span>: <span style=color:#fab387>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Users can configure their own advanced scoring parameters, so I had to parse this as a dictionary of type <code>[String: Double]</code>.</p><p>Anilist is supposed to return Doubles here, but I discovered when parsing a huge array that contained this nested object, that there was a case in which it returned something like this instead:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e3a1>&#34;advancedScores&#34;</span>: {
</span></span><span style=display:flex><span>		<span style=color:#a6e3a1>&#34;Story&#34;</span>: <span style=color:#a6e3a1>&#34;0&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e3a1>&#34;Characters&#34;</span>: <span style=color:#fab387>0</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e3a1>&#34;Visual&#34;</span>: <span style=color:#fab387>0</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e3a1>&#34;Audio&#34;</span>: <span style=color:#fab387>0</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e3a1>&#34;Enjoyment&#34;</span>: <span style=color:#fab387>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For reasons entirely unknown to me (and to the people who had worked with the Anilist API), the &ldquo;Story&rdquo; key was returning with its value as a String. This only happened in one object in a gigantic array of around 900 objects that had this nested object.</p><p>To deal with this, I made the assumption that the values here are always floating points. My decision was backed up by the Anilist docs and by the community who had used the API.</p><p>Before I stumbled upon this problem, my model looked like this (simplified):</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>class</span> <span style=color:#f9e2af>UserMediaEntry</span>: Codable {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>advancedScores</span> : [<span style=color:#89dceb>String</span>: <span style=color:#89dceb>Double</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In order to parse the value of the dictionary, I ended up creating an intermediary object called <code>WrappedDouble</code>.</p><p>The <code>Decoder</code> object we receive from the <code>required init(from decoder: Decoder)</code> has one more useful container: <code>singleValueContainer()</code>. We can use it to decode a single value without having to pass in the <code>CodingKey</code>s or anything like that.</p><p>The implementation of wrapped value is as follows:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>class</span> <span style=color:#f9e2af>WrappedDouble</span>: Codable {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>value</span>: <span style=color:#89dceb>Double</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>required</span> <span style=color:#f38ba8>init</span>(from decoder: Decoder) <span style=color:#cba6f7>throws</span> {
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>container</span> = <span style=color:#cba6f7>try</span> decoder.singleValueContainer()
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>do</span> {
</span></span><span style=display:flex><span>            <span style=color:#6c7086;font-style:italic>// Try to parse it as a Double</span>
</span></span><span style=display:flex><span>            value = <span style=color:#cba6f7>try</span> container.decode(<span style=color:#89dceb>Double</span>.<span style=color:#fab387>self</span>)
</span></span><span style=display:flex><span>        } <span style=color:#cba6f7>catch</span> {
</span></span><span style=display:flex><span>            <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>tempString</span> = <span style=color:#cba6f7>try</span> container.decode(<span style=color:#89dceb>String</span>.<span style=color:#fab387>self</span>)
</span></span><span style=display:flex><span>            <span style=color:#cba6f7>if</span> <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>convertedDouble</span> = <span style=color:#89dceb>Double</span>(tempString) {
</span></span><span style=display:flex><span>                value = convertedDouble
</span></span><span style=display:flex><span>            } <span style=color:#cba6f7>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#cba6f7>throw</span> error
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This parser will take in a single value, and the rest of the logic is pretty straightforward: We try parsing this object as a <code>Double</code> first, and if that fails, we try to parse it as a String.</p><p>The <code>UserMediaEntry</code> object above now needs to be modified. We will also do slightly more manual parsing. We are not going to modify the datatype of <code>advancedScores</code> at all. Instead we will parse the <code>Double</code>s out using our <code>DoubleWrapper</code> object, get the value, and finish creating <code>UserMediaEntry</code> with them:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>class</span> <span style=color:#f9e2af>UserMediaEntry</span>: Codable {
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>required</span> <span style=color:#f38ba8>init</span>(from decoder: Decoder) <span style=color:#cba6f7>throws</span> {
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>decoder</span> = <span style=color:#cba6f7>try</span> decoder.container(keyedBy: CodingKeys.<span style=color:#fab387>self</span>)
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>wrappedDoubleDic</span> = <span style=color:#cba6f7>try</span> decoder.decode([<span style=color:#89dceb>String</span>: WrappedDouble].<span style=color:#fab387>self</span>, forKey: .advancedScores)
</span></span><span style=display:flex><span>        advancedScores = wrappedDoubleDic.mapValues { <span style=color:#f5e0dc>$0</span>.value }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>advancedScores</span> : [<span style=color:#89dceb>String</span>: <span style=color:#89dceb>Double</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Pretty straightforward. Once we have our <code>DoubleWrapper</code> object, we can try to parse a given key using <code>[String: DoubleWrapper]</code>. <code>DoubleWrapper</code> can get a double out of a <code>Double</code> itself or a String. If our init can parse that dictionary, we than map it to a new dictionary keeping the keys, but transforming them to Double instead.</p><p>(<em>Aside note</em>: <code>Dictionary.mapValues</code> will map all the dictionary values keeping their keys, so it&rsquo;s perfect to convert our <code>DoubleWrapper</code> into <code>Double</code> without any issues).</p><h1 id=conclusion>Conclusion</h1><p>JSON is oftentimes a format that is out of our control. Luckily <code>Codable</code> actually provides all the tools we need to parse extravagant JSON responses without having to drop down to <code>JSONSerialization</code>. Often times when dealing with broken (but valid) JSON, the first solution we may think of is to use the lower level APIs, but by manually overriding <code>init(from)</code>, we can do manual parsing even easier.</p></article></div></main><footer><div class=container><div class=footer-navigation><a href=https://github.com/AndyIbanez><span class=inline-svg><svg viewBox="0 0 42 40" id="svg4" width="42" height="40"><path fill="currentColor" d="m14.20936 32.20794c0 .16542-.19024.29776-.4301.29776-.27295.0248-.46319-.10752-.46319-.29776.0-.16542.19024-.29776.4301-.29776.24814-.0248.46319.10752.46319.29776zm-2.57234-.3722c-.0579.16542.10753.35566.35566.40528.21505.0827.46319.0.51282-.16542.0496-.16542-.10753-.35566-.35566-.4301-.21505-.0579-.45492.0248-.51282.19024zm3.65586-.14061c-.23986.0579-.40529.21505-.38047.40528.0248.16543.23986.27295.488.21505.23986-.0579.40528-.21505.38047-.38047-.0248-.15715-.24813-.26468-.488-.23986zM20.73531-.19734273e-6C9.2632-.19734273e-6.48748 8.7095398.48748 20.18166c0 9.17273 5.77328 17.02207 14.01964 19.78464 1.05871.19024 1.43091-.46319 1.43091-1.00081.0-.51282-.0248-3.34156-.0248-5.0785.0.0-5.78982 1.24067-7.00568-2.46481.0.0-.94292-2.40691-2.29939-3.02725.0.0-1.8941-1.29857.13234-1.27376.0.0 2.05952.16542 3.19267 2.13396 1.81139 3.19267 4.84691 2.27457 6.02969 1.72868.19023-1.32339.72786-2.24149 1.32338-2.78739-4.62358-.51281-9.28852-1.18278-9.28852-9.13964.0-2.27458.62861-3.416 1.95199-4.87172-.21505-.53763-.9181-2.7543.21506-5.6161302 1.72867-.53762 5.7071 2.2332202 5.7071 2.2332202 1.65424-.46319 3.43254-.70305 5.1943-.70305 1.76176.0 3.54006.23986 5.1943.70305.0.0 3.97843-2.7791202 5.7071-2.2332202 1.13315 2.8701002.4301 5.0785002.21505 5.6161302 1.32339 1.46399 2.13397 2.60542 2.13397 4.87172.0 7.98168-4.87172 8.61856-9.49531 9.13964.76095.65342 1.4061 1.8941 1.4061 3.83782.0 2.78739-.0248 6.23647-.0248 6.9147.0.53763.38047 1.19105 1.43091 1.00082 8.27117-2.74603 13.87903-10.59537 13.87903-19.7681C41.51252 8.7095398 32.20745-.19734273e-6 20.73533-.19734273e-6zM8.52706 28.52727c-.10752.0827-.0827.27295.0579.4301.13234.13234.32258.19024.4301.0827.10753-.0827.0827-.27295-.0579-.4301-.13233-.13234-.32257-.19024-.4301-.0827zM7.63378 27.8573c-.0579.10753.0248.23987.19023.32258.13234.0827.29777.0579.35566-.0579C8.23757 28.01446 8.15487 27.88212 7.98944 27.7994 7.82401 27.7498 7.69168 27.7746 7.63378 27.8573zm2.67986 2.94454c-.13234.10753-.0827.35566.10752.51281.19024.19024.4301.21505.53763.0827.10752-.10752.0579-.35566-.10753-.51281-.18196-.19024-.4301-.21505-.53762-.0827zM9.37072 29.58598c-.13234.0827-.13234.29776.0.488.13234.19023.35566.27295.46319.19023.13234-.10752.13234-.32257.0-.51281-.1158-.19024-.33085-.27295-.46319-.16542z" id="path2" style="stroke-width:.08271171"/></svg>
</span></a><a href=https://x.com/AndyIbanezK><span class=inline-svg><svg viewBox="0 0 50 40" id="svg4" width="50" height="40"><path fill="currentColor" d="m44.56253 9.96871c.0313.43748.0313.87506.0313 1.31254C44.59383 24.62494 34.43764 40 15.87508 40 10.1563 40 4.84383 38.34368.37506 35.4688c.81253.0937 1.5937.12495 2.4375.12495 4.71867.0 9.06249-1.5937 12.53125-4.31245-4.43751-.0938-8.15627-3.00003-9.43754-7.00006.62505.0937 1.25001.15622 1.90632.15622.90622.0 1.81254-.12505 2.65624-.34369C5.84384 23.15619 2.37498 19.09373 2.37498 14.18748v-.12495c1.3437.75 2.90633 1.21875 4.56246 1.28117-2.71876-1.81253-4.49993-4.90624-4.49993-8.40627.0-1.87497.4999-3.59372 1.37496-5.09373 4.96877 6.125 12.43756 10.12493 20.81248 10.56251-.15622-.75001-.25-1.53118-.25-2.31245C24.37495 4.5312 28.87498.0 34.46871.0c2.90623.0 5.53121 1.21875 7.37501 3.1875 2.28118-.43748 4.46867-1.28127 6.40626-2.43749-.75011 2.3438-2.34381 4.31255-4.43751 5.56246 2.03127-.21864 4.00003-.78126 5.81247-1.56244-1.37477 1.99992-3.09362 3.7811-5.06237 5.21868z" id="path2" style="stroke-width:.09619153"/></svg>
</span></a><a href=https://www.linkedin.com/in/andyibanez/><span class=inline-svg><svg viewBox="0 0 41 40" id="svg4" width="41" height="40"><path fill="currentColor" d="M9.45332 40H1.16028V13.29405H9.45332zM5.30234 9.65111c-2.65185.0-4.80279-2.19648-4.80279-4.84832a4.80279 4.80279.0 019.60558.0c0 2.65184-2.15184 4.84832-4.80279 4.84832zM40.49152 40H32.21633V26.99971c0-3.09828-.0625-7.07159-4.3117-7.07159-4.3117.0-4.97243 3.36615-4.97243 6.84837V40H14.64808V13.29405h7.95375v3.64294h.11608c1.10716-2.09827 3.81169-4.3126 7.8466-4.3126 8.39304.0 9.93594 5.52691 9.93594 12.70564V40z" id="path2" style="stroke-width:.08928771"/></svg>
</span></a><a href=https://www.andyibanez.com/blog/index.xml><span class=inline-svg><svg viewBox="0 0 40 40" id="svg4" width="40" height="40"><path fill="currentColor" d="m11.435816 34.282008c0 3.15793-2.5599899 5.71793-5.7179299 5.71793s-5.717840022654-2.56-5.717840022654-5.71793c0-3.15794 2.559990022654-5.71793 5.717930022654-5.71793s5.7178399 2.56008 5.7178399 5.71793zm15.68388 4.21873C26.373806 24.697208 15.317496 13.626978 1.4992361 12.880288.68361608 12.836188.46077346e-4 13.491538.46077346e-4 14.308318v4.29186c0 .75134.579460002654 1.38142 1.329190022654 1.43017 9.9849699.65036 17.9886099 8.63408 18.6402999 18.6403.0488.74973.67893 1.3292 1.43018 1.3292h4.29186c.81687 9e-5 1.47223-.68348 1.42812-1.49911zm12.87933.0257C39.249566 17.649718 22.452206.754048 1.4735261.00092799867.66727608-.027972.46077346e-4.623338.46077346e-4 1.430038v4.29177c0 .77008.610270002654 1.39687 1.379730022654 1.42848 17.0694999.6999 30.7701699 14.40316 31.4699899 31.46999.0315.76946.6583 1.37972 1.42848 1.37972h4.29177c.8066-8e-5 1.45794-.66731 1.42901-1.47356z" id="path2" style="stroke-width:.08928544"/></svg>
</span></a><a href=https://www.andyibanez.com/curriculum/><span class=inline-svg><svg viewBox="0 0 15680 20480" id="svg4" width="35" height="40"><path fill="currentColor" d="M11655.83 12824.48 7840.0001 16640.464 4024.17 12824.48c-2859.863 123.906-5143.7701 2463.775-5143.7701 5352.003v384.005c0 1059.853 859.96601 1919.512 1919.92167 1919.512H14879.678c1059.956.0 1919.922-859.659 1919.922-1919.512v-384.005c0-2888.228-2283.906-5228.097-5143.77-5352.003zM-575.64445 3193.1279l256.0032 59.9048v2335.7732c-279.9651 167.9381-479.9548 459.7818-479.9548 812.0422.0 335.8762 183.9639 615.9437 443.96075 787.9778l-623.9822 2491.9352c-67.9944 275.9716 84.02025 559.6229 303.9782 559.6229H996.31762c219.95798.0 371.97268-283.6513 303.97828-559.6229L676.31362 7188.8259c259.99685-172.0341 443.96078-452.1016 443.96078-787.9778.0-352.2604-199.98973-644.1041-479.95483-812.0422V3484.9716l2639.90503 635.9119c-344.0171 688.1366-559.9814 1456.1463-559.9814 2279.9646.0 2827.8113 2291.8942 5119.5519 5119.7569 5119.5519 2827.8619.0 5119.7569-2291.7406 5119.7569-5119.5519.0-823.8183-211.971-1591.828-559.982-2279.9646l3851.824-927.7556c727.971-176.1302 727.971-1083.9175.0-1260.0477L8635.9653 92.929226c-519.9937-123.905551-1067.943-123.905551-1587.9367.0L-575.64445 1928.9841c-723.92585 176.1302-723.92585 1088.0136.0 1264.1438z" id="path2" style="stroke-width:39.99821472"/></svg>
</span></a><a href=https://www.andyibanez.com/contact-me><span class=inline-svg><svg viewBox="0 0 40 40" id="svg4" width="40" height="40"><path fill="currentColor" d="m39.99999 36.249999c0 2.0711-1.6789 3.75-3.74999 3.75H3.75c-2.07109.0-3.74999-1.6789-3.74999-3.75v-20.56843a3.7499996 3.7499996.0 011.43648-2.95125c1.94633-1.5257 3.55476-2.7628904 12.82812-9.4930404C15.57906 2.2789186 18.18727-.02709136 20 .00024864227 21.81234-.02745136 24.42156 2.2793086 25.73539 3.2371986c9.27242 6.72945 10.88304 7.9683604 12.82812 9.4931204a3.7499996 3.7499996.0 011.43648 2.95125zm-5.13015-15.35976c-.20024-.29125-.60156-.35898-.88586-.14898-1.78476 1.3182-4.33297 3.18008-8.24859 6.02179-1.31445.95828-3.92266 3.26414-5.73539 3.23672-1.81336.0269-4.41867-2.2768-5.73539-3.23672-3.91515-2.8414-6.46359-4.70343-8.24859-6.02179-.2843-.21-.68562-.14227-.88586.14898l-.70875 1.03094a.62484368.62484368.0 00.14367.8568c1.78805 1.32023 4.33235 3.1789 8.2268 6.00531 1.5839 1.15476 4.41593 3.73539 7.20812 3.71664 2.79094.0189 5.62195-2.56024 7.20804-3.71664 3.89453-2.82649 6.43891-4.68516 8.2268-6.00531a.62484368.62484368.0 00.14367-.8568z" id="path2" style="stroke-width:.07812498"/></svg></span></a></div></div><p class=made-with-love><a href=https://github.com/humrochagf/colordrop><b>Colordrop</b>
</a><span>theme | Made </span><span>by</span>
<a href=https://humberto.io/><b>Humberto Rocha</b></a></p></footer></div><script src=/copy/copy.js></script><script src=/search/elasticlunr.min.js></script><script src=/search/search.js></script><script>loadSearch()</script></body></html>