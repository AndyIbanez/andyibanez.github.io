<!doctype html><html prefix="og: http://ogp.me/ns#" lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,user-scalable=no"><meta http-equiv=x-ua-compatible content="ie=edge"><script async src="https://www.googletagmanager.com/gtag/js?id=G-CE7T69YX8Y"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CE7T69YX8Y")}</script><link rel=apple-touch-icon sizes=180x180 href=https://www.andyibanez.com/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png sizes=32x32 href=https://www.andyibanez.com/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.andyibanez.com/favicons/favicon-16x16.png><link rel=manifest href=https://www.andyibanez.com/favicons/site.webmanifest><link rel=mask-icon href=https://www.andyibanez.com/favicons/safari-pinned-tab.svg color=#292148><meta name=msapplication-TileColor content="#292148"><meta name=msapplication-config content="https://www.andyibanez.com/favicons/browserconfig.xml"><meta name=theme-color content="#292148"><link rel=canonical href=https://www.andyibanez.com/posts/using-aswebauthenticationaession-swiftui/><link rel=alternate hreflang=en href=https://www.andyibanez.com/posts/using-aswebauthenticationaession-swiftui/ title><meta name=description content="Learn how to integrate ASWebAuthenticationSession with SwiftUI"><meta name=author content><meta name=theme-color content="#292148"><meta itemprop=name content="Using ASWebAuthenticationSession with SwiftUI"><meta itemprop=description content="Learn how to integrate ASWebAuthenticationSession with SwiftUI"><meta itemprop=datePublished content="2020-09-02T07:00:00-04:00"><meta itemprop=dateModified content="2020-09-02T07:00:00-04:00"><meta itemprop=wordCount content="1915"><meta itemprop=keywords content="apple,swift,ios,programming,ipados,tvos,macos,swiftui"><meta property="og:url" content="https://www.andyibanez.com/posts/using-aswebauthenticationaession-swiftui/"><meta property="og:site_name" content="Andy Ibanez"><meta property="og:title" content="Using ASWebAuthenticationSession with SwiftUI"><meta property="og:description" content="Learn how to integrate ASWebAuthenticationSession with SwiftUI"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-02T07:00:00-04:00"><meta property="article:modified_time" content="2020-09-02T07:00:00-04:00"><meta property="article:tag" content="Apple"><meta property="article:tag" content="Swift"><meta property="article:tag" content="Ios"><meta property="article:tag" content="Programming"><meta property="article:tag" content="Ipados"><meta property="article:tag" content="Tvos"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using ASWebAuthenticationSession with SwiftUI"><meta name=twitter:description content="Learn how to integrate ASWebAuthenticationSession with SwiftUI"><meta name=twitter:creator content="@"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","url":"https://www.andyibanez.com/posts/using-aswebauthenticationaession-swiftui/","headline":"Using ASWebAuthenticationSession with SwiftUI","description":"Learn how to integrate ASWebAuthenticationSession with SwiftUI","datePublished":"2020-09-02","keywords":"apple,swift,ios,programming,ipados,tvos,macos,swiftui","author":{"@type":"Person","name":""}}</script><title>Using ASWebAuthenticationSession with SwiftUI - Andy Ibanez</title><link rel=stylesheet href=https://www.andyibanez.com/style.main.min.18f604b90ed15864d7faa967f1ef9eacb99e1c967eff38762ec29b7bf1ab5876.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-CE7T69YX8Y"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CE7T69YX8Y")}</script></head><body><div class=wrapper><nav><div class=container><div class=language-selector></div></div></nav><header><div class=container><div class=header-group><div class=header-logo-container><a class=header-logo-link href=https://www.andyibanez.com/><img class=header-logo-circle src=https://www.andyibanez.com/img/andy_profile.png alt="Andy Ibanez logo"></a></div><div class=header-title><a href=https://www.andyibanez.com/>Andy Ibanez</a></div></div></div></header><nav><div class=container><div class=main-navigation><a href=/about/>About Me</a><a href=/posts/>Blog</a><a href=/projects/>Projects</a><a href=/tags/>Tags</a><a href=/contact/>Contact</a><a href=/privacy-policy/>Privacy policy</a></div></div></nav><div class=container><div class=search><input type=text id=searchInput placeholder="Type here to search"></div><div class="container search-results-container" hidden=true><div id=searchResults class=search-results></div></div></div><main><div class=container><article><h1 class=title>Using ASWebAuthenticationSession with SwiftUI</h1><p class=publish>Published on
<time class=post-date datetime=2020-09-02T07:00:00-04:00>September 2, 2020</time></p><p>Working with REST APIs you have no control over can be a little monotonous. This is especially for OAuth 2.0 API that need you to do a little bit of setup, get your API keys with the service provider, and then you need to do the setup on your app&rsquo;s size: Configure your URL scheme, deal with that URL Scheme, and write code that does something when your app gets called with that URL.</p><p>In the old days of iOS development, this took quite a while. If you adopted something like the Facebook and Twitter APIs, you likely used their SDKs as they dealt with all these issues for you. If you wanted to use a service that didn&rsquo;t provide an SDK, you were of luck, and had to do quite a little bit of setup.</p><p>Luckily for us, starting on iOS 12, Apple introduced the <code>AuthenticationServices</code>, which, amongst many many things, it <em>greatly</em> simplifies the OAuth 2.0 flow for REST APIs, thanks to the <code>ASWebAuthenticationSession</code> object.</p><h1 id=initial-setup>Initial Setup</h1><p>I recently had to use the <a href=https://anilist.gitbook.io/anilist-apiv2-docs/>Anilist API</a> for an upcoming up, so a lot of the sample code will come from this project.</p><p>Regardless of the service you are interacting with, you will first need to get your API credentials.</p><p><img src=/img/nae_anilist_config.png alt="Nae Anilist Config"></p><p>At the very least, they will always give you an API secret.</p><p>You still need to configure your URL Scheme to call your app. To do this, click your project blueprint in Xcode, click <code>Info</code>, select your Target, and expand the <code>URL Types</code> section. The identifier needs to be anything in reverse DNS donation. The scheme has to be everything up to but not including <code>://</code> of your URL. Depending on the service provider, you may have the flexibility of creating your own or they will assign one to you. Set the role to <code>Viewer</code>, thought it doesn&rsquo;t really matter for iOS apps.</p><p><img src=/img/anilist_url_config.png alt="Xcode Anilist Config"></p><p>And that&rsquo;s all we need to do for the initial setup. We can now start writing some code.</p><h1 id=the-view-and-viewmodel>The View and ViewModel</h1><p>Because we are using SwiftUI, we can create our views and a companion ViewModel object.</p><h2 id=the-viewmodel>The ViewModel</h2><h3 id=the-aswebauthenticationpresentationcontextproviding-protocol>The ASWebAuthenticationPresentationContextProviding Protocol</h3><p>The ViewModel will take care of handling the actual authentication flow for us. It must conform to the <code>ASWebAuthenticationPresentationContextProviding</code> protocol.</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>class</span> <span style=color:#f9e2af>SignInViewModel</span>: NSObject, ObservableObject, ASWebAuthenticationPresentationContextProviding {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Also note the <code>NSObject</code> inheritance. This is necessary, because we are conforming to <code>ASWebAuthenticationPresentationContextProviding</code>. If you don&rsquo;t inherit from <code>NSObject</code> you will need to do a lot of implementations to satisfy the constraint, and it&rsquo;s not easy or short to do.</p><p>Before we move on, let&rsquo;s satisfy that <code>ASWebAuthenticationPresentationContextProviding</code> protocol. There&rsquo;s only one tiny method we need to implement.</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>class</span> <span style=color:#f9e2af>SignInViewModel</span>: NSObject, ObservableObject, ASWebAuthenticationPresentationContextProviding {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic>// </span><span style=color:#6c7086;font-style:italic>MARK:</span><span style=color:#6c7086;font-style:italic> - ASWebAuthenticationPresentationContextProviding</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>func</span> <span style=color:#89b4fa>presentationAnchor</span>(<span style=color:#cba6f7>for</span> session: ASWebAuthenticationSession) -&gt; ASPresentationAnchor {
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>return</span> ASPresentationAnchor()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This method is actually one of the source of confusion developers have when they try to integrate this framework with web logins. I have seen implementations where people try to get a reference to <code>UIWindow</code> and all other kinds of hacky jobs to get this to work, but nothing like that is necessary. In SwiftUI 2, it&rsquo;s not easy (is it even possible?) To get a reference to the main window and use that as the presentation anchor, so it&rsquo;s good to know you don&rsquo;t need to keep any kind of whacky references to get this to work.</p><p>Everything this method is doing is telling the framework &ldquo;hey, use use a presentation anchor appropriate for this platform&rdquo;. You don&rsquo;t need to give it any other context information or references. In fact, the <code>ASPresentationAnchor</code> documentation states:</p><blockquote><p>A platform-specific type that indicates the kind of user interface element to use as a presentation anchor.</p></blockquote><p>The system will choose the right anchor for you, so you don&rsquo;t have to worry about grabbing one up from up above the view hierarchy.</p><p>Furthermore, the documentation even tells you how it is implemented:</p><p>For iOS, Mac Catalyst, tvOS:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>typealias</span> ASPresentationAnchor = UIWindow
</span></span></code></pre></div><p>for macOS:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>typealias</span> ASPresentationAnchor = NSWindow
</span></span></code></pre></div><p>So no need to grab references or anything. Just return <code>ASPresentationAnchor</code> and let the framework do the rest.</p><h3 id=the-signin-method>The SignIn Method</h3><p>We can finally write the actual code that will show up the login UI. The login UI is a website provided by the OAuth 2.0 service, where the user logs in without having to enter their credentials directly into their app. Once the user finishes the login flow with the service, the service calls your custom URL Scheme with a longer URL that contains an access token.</p><pre tabindex=0><code>    func signIn() {
        let signInPromise = Future&lt;URL, Error&gt; { completion in
            let apiData = AnilistAPIConfigurations.load()
            let authUrl = AnilistAuthenticationURLBuilder(clientID: apiData.id)()
            
            let authSession = ASWebAuthenticationSession(
                url: authUrl, callbackURLScheme:
                    apiData.redirectURL.absoluteString) { (url, error) in
                if let error = error {
                    completion(.failure(error))
                } else if let url = url {
                    completion(.success(url))
                }
            }
            
            authSession.presentationContextProvider = self
            authSession.prefersEphemeralWebBrowserSession = true
            authSession.start()
        }
        
        signInPromise.sink { (completion) in
            switch completion {
            case .failure(let error): // Handle the error here. An error can even be when the user cancels authentication.
            default: break
            }
        } receiveValue: { (url) in
            self.processResponseURL(url: url)
        }
        .store(in: &amp;subscriptions)
    }
</code></pre><p>This looks like a lot, so let&rsquo;s look at it step by step.</p><p>First, I&rsquo;m getting into the habit of reducing the amount of callback code I have. For this reason, when I find a native API that requires a callback, I wrap it in a combine <code>Future</code>. For more info, check out my <a href=https://www.andyibanez.com/posts/wrapping-asynchronous-apis-into-combine-futures/>Wrapping Asynchronous APIs into Combine Futures</a> article. You do not need to do this, and you can use the callback and its results directly.</p><p>Second, we have a <code>AnilistAPIConfiguration</code> object that calls a static <code>load()</code> object.</p><p>I bundle an API config file in my app that is simple a JSON file with my API credentials. For those raising eyebrows at this, you are allowed to do this as long as your service provider allows you to use implicit grants.</p><p>The JSON file looks like this:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e3a1>&#34;id&#34;</span>: <span style=color:#fab387>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e3a1>&#34;secret&#34;</span>: <span style=color:#a6e3a1>&#34;api_secret&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e3a1>&#34;name&#34;</span>: <span style=color:#a6e3a1>&#34;Nae for Anilist&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e3a1>&#34;redirectURL&#34;</span>: <span style=color:#a6e3a1>&#34;fairese-nae://anilist-auth&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>All the values here were given to my by service provider (Anilist). You may need to adapt this or provide your credentials in an entire different way depending on your API provider.</p><p>The <code>AnilistAPIConfigurations</code> class is implemented like this:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>public</span> <span style=color:#f38ba8>class</span> <span style=color:#f9e2af>AnilistAPIConfigurations</span>: Codable {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>public</span> <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>id</span>: <span style=color:#89dceb>Int</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>public</span> <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>secret</span>: <span style=color:#89dceb>String</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>public</span> <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>name</span>: <span style=color:#89dceb>String</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>public</span> <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>redirectURL</span>: URL
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>static</span> <span style=color:#f38ba8>func</span> <span style=color:#89b4fa>load</span>() -&gt; AnilistAPIConfigurations {
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>filePath</span> = Bundle.main.url(forResource: <span style=color:#a6e3a1>&#34;anilist_api&#34;</span>, withExtension: <span style=color:#a6e3a1>&#34;json&#34;</span>)<span style=color:#89dceb;font-weight:700>!</span>
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>data</span> = <span style=color:#cba6f7>try</span>! Data(contentsOf: filePath)
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>object</span> = <span style=color:#cba6f7>try</span>! JSONDecoder().decode(AnilistAPIConfigurations.<span style=color:#fab387>self</span>, from: data)
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>return</span> object
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>load()</code> does not safely unwrap, because I want it to fail when it&rsquo;s not possible to use my credentials.</p><p>The <code>AnilistAuthenticationURLBuilder</code> builds the authentication URL for the service. You could hardcore your URL here directly, or anything else. Just know you need an authentication URL the service will call based on your API secret and other info. The implementation of this object is the following:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#6c7086;font-style:italic>/// Builds authentication URLs.</span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>public</span> <span style=color:#f38ba8>class</span> <span style=color:#f9e2af>AnilistAuthenticationURLBuilder</span> {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic>/// The domain URL</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>domain</span>: <span style=color:#89dceb>String</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic>/// Client ID</span>
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>clientID</span>: <span style=color:#89dceb>Int</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>init</span>(
</span></span><span style=display:flex><span>        domain: <span style=color:#89dceb>String</span> = <span style=color:#a6e3a1>&#34;anilist.co&#34;</span>,
</span></span><span style=display:flex><span>        clientID: <span style=color:#89dceb>Int</span>) {
</span></span><span style=display:flex><span>        <span style=color:#fab387>self</span>.domain = domain
</span></span><span style=display:flex><span>        <span style=color:#fab387>self</span>.clientID = clientID
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>var</span> <span style=color:#f5e0dc>url</span>: URL {
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>var</span> <span style=color:#f5e0dc>components</span> = URLComponents()
</span></span><span style=display:flex><span>        components.scheme = <span style=color:#a6e3a1>&#34;https&#34;</span>
</span></span><span style=display:flex><span>        components.host = domain
</span></span><span style=display:flex><span>        components.path = <span style=color:#a6e3a1>&#34;/api/v2/oauth/authorize&#34;</span>
</span></span><span style=display:flex><span>        components.queryItems =
</span></span><span style=display:flex><span>            [
</span></span><span style=display:flex><span>                <span style=color:#a6e3a1>&#34;client_id&#34;</span>: <span style=color:#89dceb>String</span>(clientID),
</span></span><span style=display:flex><span>                <span style=color:#a6e3a1>&#34;response_type&#34;</span>: <span style=color:#a6e3a1>&#34;token&#34;</span>
</span></span><span style=display:flex><span>            ].<span style=color:#89dceb>map</span> { URLQueryItem(name: <span style=color:#f5e0dc>$0</span>, value: <span style=color:#f5e0dc>$1</span>) }
</span></span><span style=display:flex><span>        <span style=color:#cba6f7>return</span> components.url!
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>func</span> <span style=color:#89b4fa>callAsFunction</span>() -&gt; URL {
</span></span><span style=display:flex><span>        url
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Anilist requires you build the URL with the client ID. The secret is not necessary for this specific API (and grant type).</p><p>Next, we have the core of this article - the <code>ASWebAuthenticationSession</code> object.</p><p>To create this object, you need to give it:</p><ul><li>The Authentication URL (<code>authUrl</code>). This is the URL that the web view will display once it loads. It will show the service&rsquo;s login page in which your users write their credentials and finish the login flow.</li><li>The callback URL Scheme: This is the scheme that was both provided by the service and that we configured in our project&rsquo;s Target.</li><li>A callback: The callback will give us an error or an URL containing the access token and possibly other login info. When the callback gets called, at the very least we need to grab the access token and store it in our app for authenticated requests.</li></ul><p>I have also set two additional properties:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>authSession.presentationContextProvider = authSession.prefersEphemeralWebBrowserSession = <span style=color:#fab387>true</span>
</span></span></code></pre></div><p>The former is necessary, as that will assign us as the context provider. The later sets the web browser session as ephemeral, meaning that each time we show this web view, it will not try to use any cookies or data from a past authentication session. I do this because if the user logs out of the app, they may want to login into a different account.</p><p>Finally, once you call <code>start()</code>, the session will start, the web view will be displayed, and your user will be able to authenticate against the service.</p><h3 id=handling-the-response>Handling the Response</h3><p>If the callback gets called successfully with an URL, we need to parse out the access token and store it. I will leave the storage details to you as that will depend on how secure the token must be and your own needs.</p><p>To parse out the token, I created the <code>processResponseURL(_)</code> method:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#f38ba8>func</span> <span style=color:#89b4fa>processResponseURL</span>(url: URL) {
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>anilistComponents</span> = URLComponents(url: url, resolvingAgainstBaseURL: <span style=color:#fab387>true</span>)
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic>// Anilist actually returns the token in a messed up way.</span>
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic>// All the parameters - including query parameters - are AFTER the fragment.</span>
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic>// So I can&#39;t just access the query property of these components to get all the data I need.</span>
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic>// To work around this and save myself the headache of possible encoding issues, I will create</span>
</span></span><span style=display:flex><span>    <span style=color:#6c7086;font-style:italic>// a new URL using the fragment of the old components and some dummy domain.</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>if</span>  <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>anilistFragment</span> = anilistComponents?.fragment,
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>dummyURL</span> = URL(string: <span style=color:#a6e3a1>&#34;http://dummyurl.com?</span><span style=color:#a6e3a1>\(</span>anilistFragment<span style=color:#a6e3a1>)</span><span style=color:#a6e3a1>&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>components</span> = URLComponents(url: dummyURL, resolvingAgainstBaseURL: <span style=color:#fab387>true</span>),
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>queryItems</span> = components.queryItems,
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>token</span> = queryItems.<span style=color:#89dceb>filter</span> ({ <span style=color:#f5e0dc>$0</span>.name == <span style=color:#a6e3a1>&#34;access_token&#34;</span> }).<span style=color:#89dceb>first</span>?.value,
</span></span><span style=display:flex><span>        <span style=color:#f38ba8>let</span> <span style=color:#f5e0dc>expirationDate</span> = queryItems.<span style=color:#89dceb>filter</span> ({ <span style=color:#f5e0dc>$0</span>.name == <span style=color:#a6e3a1>&#34;expires_in&#34;</span> }).<span style=color:#89dceb>first</span>?.value
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#6c7086;font-style:italic>/// Store the token</span>
</span></span><span style=display:flex><span>        <span style=color:#6c7086;font-style:italic>/// Store the token expiration date if necessary.</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This implementation is a bit specific to Anilist. Anilist currently returns the URL query parameters <em>after</em> the fragment, so we cannot grab them with URLComponents&rsquo; queryItems property. I had to create a dummy URL, create it with the contents of the response, and grab the token from there. It&rsquo;s likely that if you use this with another service, you will not need to this as they are likely to return the URL query and fragment (everything after the <code>#</code>) correctly.</p><p>For more info on <code>URLComponents</code>, you can read <a href=https://www.andyibanez.com/posts/building-urls-with-nsurlcomponents/>this article</a>.</p><h2 id=the-view>The View</h2><p>Finally, the view will call our ViewModel&rsquo;s <code>signIn</code> method, showing the web view. The I used for this is simply this one:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>struct</span> <span style=color:#f9e2af>SignInView</span>: View {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    @StateObject <span style=color:#f38ba8>var</span> <span style=color:#f5e0dc>viewModel</span> = SignInViewModel()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f38ba8>var</span> <span style=color:#f5e0dc>body</span>: some View {
</span></span><span style=display:flex><span>        VStack(spacing: <span style=color:#fab387>16</span>) {
</span></span><span style=display:flex><span>            Image(systemName: <span style=color:#a6e3a1>&#34;person.circle&#34;</span>)
</span></span><span style=display:flex><span>                .resizable()
</span></span><span style=display:flex><span>                .frame(width: <span style=color:#fab387>50</span>, height: <span style=color:#fab387>50</span>)
</span></span><span style=display:flex><span>                .foregroundColor(colorForTheme(color))
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            VStack(spacing: <span style=color:#fab387>8</span>) {
</span></span><span style=display:flex><span>                Text(<span style=color:#a6e3a1>&#34;You must be logged in to your Anilist account to use this feature&#34;</span>)
</span></span><span style=display:flex><span>                    .foregroundColor(.secondary)
</span></span><span style=display:flex><span>                    .font(.title3)
</span></span><span style=display:flex><span>                    .multilineTextAlignment(.center)
</span></span><span style=display:flex><span>                    .padding()
</span></span><span style=display:flex><span>                Button {
</span></span><span style=display:flex><span>                    viewModel.signIn()
</span></span><span style=display:flex><span>                } label: {
</span></span><span style=display:flex><span>                    Text(<span style=color:#a6e3a1>&#34;Sign In&#34;</span>)
</span></span><span style=display:flex><span>                        .foregroundColor(.white)
</span></span><span style=display:flex><span>                        .padding()
</span></span><span style=display:flex><span>                        .background(colorForTheme(color))
</span></span><span style=display:flex><span>                        .clipShape(RoundedRectangle(cornerRadius: <span style=color:#fab387>8</span>))
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=/img/nae_login.png alt="Nae Login"></p><p>Tapping the Sign In button will show a web view:</p><p><img src=/img/nae_anilist_login_webview.png alt="Nae Anilist Login"></p><h1 id=conclusion>Conclusion</h1><p><code>ASWebAuthenticationSession</code> is one of the hidden gems from WWDC18. Authorizing your app with third party web services is now easier than ever, and you can get it done in just a few hours of code, without having to engage in heavy configurations or callbacks.</p></article></div></main><footer><div class=container><div class=footer-navigation><a href=https://github.com/AndyIbanez><span class=inline-svg><svg viewBox="0 0 42 40" id="svg4" width="42" height="40"><path fill="currentColor" d="m14.20936 32.20794c0 .16542-.19024.29776-.4301.29776-.27295.0248-.46319-.10752-.46319-.29776.0-.16542.19024-.29776.4301-.29776.24814-.0248.46319.10752.46319.29776zm-2.57234-.3722c-.0579.16542.10753.35566.35566.40528.21505.0827.46319.0.51282-.16542.0496-.16542-.10753-.35566-.35566-.4301-.21505-.0579-.45492.0248-.51282.19024zm3.65586-.14061c-.23986.0579-.40529.21505-.38047.40528.0248.16543.23986.27295.488.21505.23986-.0579.40528-.21505.38047-.38047-.0248-.15715-.24813-.26468-.488-.23986zM20.73531-.19734273e-6C9.2632-.19734273e-6.48748 8.7095398.48748 20.18166c0 9.17273 5.77328 17.02207 14.01964 19.78464 1.05871.19024 1.43091-.46319 1.43091-1.00081.0-.51282-.0248-3.34156-.0248-5.0785.0.0-5.78982 1.24067-7.00568-2.46481.0.0-.94292-2.40691-2.29939-3.02725.0.0-1.8941-1.29857.13234-1.27376.0.0 2.05952.16542 3.19267 2.13396 1.81139 3.19267 4.84691 2.27457 6.02969 1.72868.19023-1.32339.72786-2.24149 1.32338-2.78739-4.62358-.51281-9.28852-1.18278-9.28852-9.13964.0-2.27458.62861-3.416 1.95199-4.87172-.21505-.53763-.9181-2.7543.21506-5.6161302 1.72867-.53762 5.7071 2.2332202 5.7071 2.2332202 1.65424-.46319 3.43254-.70305 5.1943-.70305 1.76176.0 3.54006.23986 5.1943.70305.0.0 3.97843-2.7791202 5.7071-2.2332202 1.13315 2.8701002.4301 5.0785002.21505 5.6161302 1.32339 1.46399 2.13397 2.60542 2.13397 4.87172.0 7.98168-4.87172 8.61856-9.49531 9.13964.76095.65342 1.4061 1.8941 1.4061 3.83782.0 2.78739-.0248 6.23647-.0248 6.9147.0.53763.38047 1.19105 1.43091 1.00082 8.27117-2.74603 13.87903-10.59537 13.87903-19.7681C41.51252 8.7095398 32.20745-.19734273e-6 20.73533-.19734273e-6zM8.52706 28.52727c-.10752.0827-.0827.27295.0579.4301.13234.13234.32258.19024.4301.0827.10753-.0827.0827-.27295-.0579-.4301-.13233-.13234-.32257-.19024-.4301-.0827zM7.63378 27.8573c-.0579.10753.0248.23987.19023.32258.13234.0827.29777.0579.35566-.0579C8.23757 28.01446 8.15487 27.88212 7.98944 27.7994 7.82401 27.7498 7.69168 27.7746 7.63378 27.8573zm2.67986 2.94454c-.13234.10753-.0827.35566.10752.51281.19024.19024.4301.21505.53763.0827.10752-.10752.0579-.35566-.10753-.51281-.18196-.19024-.4301-.21505-.53762-.0827zM9.37072 29.58598c-.13234.0827-.13234.29776.0.488.13234.19023.35566.27295.46319.19023.13234-.10752.13234-.32257.0-.51281-.1158-.19024-.33085-.27295-.46319-.16542z" id="path2" style="stroke-width:.08271171"/></svg>
</span></a><a href=https://x.com/AndyIbanezK><span class=inline-svg><svg viewBox="0 0 50 40" id="svg4" width="50" height="40"><path fill="currentColor" d="m44.56253 9.96871c.0313.43748.0313.87506.0313 1.31254C44.59383 24.62494 34.43764 40 15.87508 40 10.1563 40 4.84383 38.34368.37506 35.4688c.81253.0937 1.5937.12495 2.4375.12495 4.71867.0 9.06249-1.5937 12.53125-4.31245-4.43751-.0938-8.15627-3.00003-9.43754-7.00006.62505.0937 1.25001.15622 1.90632.15622.90622.0 1.81254-.12505 2.65624-.34369C5.84384 23.15619 2.37498 19.09373 2.37498 14.18748v-.12495c1.3437.75 2.90633 1.21875 4.56246 1.28117-2.71876-1.81253-4.49993-4.90624-4.49993-8.40627.0-1.87497.4999-3.59372 1.37496-5.09373 4.96877 6.125 12.43756 10.12493 20.81248 10.56251-.15622-.75001-.25-1.53118-.25-2.31245C24.37495 4.5312 28.87498.0 34.46871.0c2.90623.0 5.53121 1.21875 7.37501 3.1875 2.28118-.43748 4.46867-1.28127 6.40626-2.43749-.75011 2.3438-2.34381 4.31255-4.43751 5.56246 2.03127-.21864 4.00003-.78126 5.81247-1.56244-1.37477 1.99992-3.09362 3.7811-5.06237 5.21868z" id="path2" style="stroke-width:.09619153"/></svg>
</span></a><a href=https://www.linkedin.com/in/andyibanez/><span class=inline-svg><svg viewBox="0 0 41 40" id="svg4" width="41" height="40"><path fill="currentColor" d="M9.45332 40H1.16028V13.29405H9.45332zM5.30234 9.65111c-2.65185.0-4.80279-2.19648-4.80279-4.84832a4.80279 4.80279.0 019.60558.0c0 2.65184-2.15184 4.84832-4.80279 4.84832zM40.49152 40H32.21633V26.99971c0-3.09828-.0625-7.07159-4.3117-7.07159-4.3117.0-4.97243 3.36615-4.97243 6.84837V40H14.64808V13.29405h7.95375v3.64294h.11608c1.10716-2.09827 3.81169-4.3126 7.8466-4.3126 8.39304.0 9.93594 5.52691 9.93594 12.70564V40z" id="path2" style="stroke-width:.08928771"/></svg>
</span></a><a href=https://www.andyibanez.com/posts/index.xml><span class=inline-svg><svg viewBox="0 0 40 40" id="svg4" width="40" height="40"><path fill="currentColor" d="m11.435816 34.282008c0 3.15793-2.5599899 5.71793-5.7179299 5.71793s-5.717840022654-2.56-5.717840022654-5.71793c0-3.15794 2.559990022654-5.71793 5.717930022654-5.71793s5.7178399 2.56008 5.7178399 5.71793zm15.68388 4.21873C26.373806 24.697208 15.317496 13.626978 1.4992361 12.880288.68361608 12.836188.46077346e-4 13.491538.46077346e-4 14.308318v4.29186c0 .75134.579460002654 1.38142 1.329190022654 1.43017 9.9849699.65036 17.9886099 8.63408 18.6402999 18.6403.0488.74973.67893 1.3292 1.43018 1.3292h4.29186c.81687 9e-5 1.47223-.68348 1.42812-1.49911zm12.87933.0257C39.249566 17.649718 22.452206.754048 1.4735261.00092799867.66727608-.027972.46077346e-4.623338.46077346e-4 1.430038v4.29177c0 .77008.610270002654 1.39687 1.379730022654 1.42848 17.0694999.6999 30.7701699 14.40316 31.4699899 31.46999.0315.76946.6583 1.37972 1.42848 1.37972h4.29177c.8066-8e-5 1.45794-.66731 1.42901-1.47356z" id="path2" style="stroke-width:.08928544"/></svg>
</span></a><a href=https://www.andyibanez.com/contact><span class=inline-svg><svg viewBox="0 0 40 40" id="svg4" width="40" height="40"><path fill="currentColor" d="m39.99999 36.249999c0 2.0711-1.6789 3.75-3.74999 3.75H3.75c-2.07109.0-3.74999-1.6789-3.74999-3.75v-20.56843a3.7499996 3.7499996.0 011.43648-2.95125c1.94633-1.5257 3.55476-2.7628904 12.82812-9.4930404C15.57906 2.2789186 18.18727-.02709136 20 .00024864227 21.81234-.02745136 24.42156 2.2793086 25.73539 3.2371986c9.27242 6.72945 10.88304 7.9683604 12.82812 9.4931204a3.7499996 3.7499996.0 011.43648 2.95125zm-5.13015-15.35976c-.20024-.29125-.60156-.35898-.88586-.14898-1.78476 1.3182-4.33297 3.18008-8.24859 6.02179-1.31445.95828-3.92266 3.26414-5.73539 3.23672-1.81336.0269-4.41867-2.2768-5.73539-3.23672-3.91515-2.8414-6.46359-4.70343-8.24859-6.02179-.2843-.21-.68562-.14227-.88586.14898l-.70875 1.03094a.62484368.62484368.0 00.14367.8568c1.78805 1.32023 4.33235 3.1789 8.2268 6.00531 1.5839 1.15476 4.41593 3.73539 7.20812 3.71664 2.79094.0189 5.62195-2.56024 7.20804-3.71664 3.89453-2.82649 6.43891-4.68516 8.2268-6.00531a.62484368.62484368.0 00.14367-.8568z" id="path2" style="stroke-width:.07812498"/></svg></span></a></div></div><p class=made-with-love><a href=https://github.com/humrochagf/colordrop><b>Colordrop</b>
</a><span>theme | Made </span><span>by</span>
<a href=https://humberto.io/><b>Humberto Rocha</b></a></p></footer></div><script src=/copy/copy.js></script><script src=/search/elasticlunr.min.js></script><script src=/search/search.js></script><script>loadSearch("https://www.andyibanez.com/index.json")</script></body></html>